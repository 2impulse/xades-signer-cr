package com.workoutstudioapp.xadessignercr;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.security.KeyStoreException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.TransformerConfigurationException;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactoryConfigurationError;

import org.apache.xml.security.transforms.Transforms;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.xml.sax.SAXException;

import xades4j.XAdES4jException;
import xades4j.production.DataObjectReference;
import xades4j.production.SignedDataObjects;
import xades4j.production.XadesBesSigningProfile;
import xades4j.production.XadesSignatureResult;
import xades4j.production.XadesSigner;
import xades4j.production.XadesSigningProfile;
import xades4j.properties.AllDataObjsCommitmentTypeProperty;
import xades4j.properties.DataObjectDesc;
import xades4j.properties.DataObjectTransform;
import xades4j.providers.KeyingDataProvider;
import xades4j.providers.SigningCertChainException;
import xades4j.providers.impl.FileSystemKeyStoreKeyingDataProvider;
import xades4j.verification.UnexpectedJCAException;

public class Signer {

	public static void main(String[] args) {
		Signer signer = new Signer();
		signer.sign("../test-data/cert.p12", "1234", "../test-data/factura.xml", "../test-data/out.xml");
	}
	public void sign(String keyPath, String password, String xmlInPath, String xmlOutPath) {
		try {
			File keyFile = new File(keyPath);
			if (!keyFile.exists()) {
				System.err.println("key file is missing for path: " + keyPath);
			}
			XadesSigner signer = getSigner(password, keyPath);
			signWithoutIDEnveloped(xmlInPath, xmlOutPath, signer);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	private XadesSigner getSigner(String password, String pfxPath) throws Exception {
        KeyingDataProvider keyingProvider = getKeyingDataProvider(pfxPath, password);
        XadesSigningProfile p = new XadesBesSigningProfile(keyingProvider);
        return p.newSigner();
    }
    private KeyingDataProvider getKeyingDataProvider(String pfxPath, String password) throws KeyStoreException, SigningCertChainException, UnexpectedJCAException {
        KeyingDataProvider keyingProvider = new FileSystemKeyStoreKeyingDataProvider("pkcs12", pfxPath, new FirstCertificateSelector(), new DirectPasswordProvider(password), new DirectPasswordProvider(password), true);
        if (keyingProvider.getSigningCertificateChain().isEmpty()) {
            throw new IllegalArgumentException("Cannot initialize keystore with path " + pfxPath);
        }
        return keyingProvider;
    }
    private static void signWithoutIDEnveloped(String inputPath, String outputPath, XadesSigner signer) throws TransformerFactoryConfigurationError, XAdES4jException, TransformerConfigurationException, TransformerException, IOException, FileNotFoundException {
        // Copy source doc into target document
        Document sourceDoc = getDocument(inputPath);
        sourceDoc.setDocumentURI(null);

        writeXMLToFile(sourceDoc, outputPath);

        sourceDoc = getDocument(outputPath);

        Element signatureParent = (Element) sourceDoc.getDocumentElement();
        Element elementToSign = sourceDoc.getDocumentElement();
        String refUri;
        if (elementToSign.hasAttribute("Id")) {
            refUri = '#' + elementToSign.getAttribute("Id");
        } else {
            if (elementToSign.getParentNode().getNodeType() != Node.DOCUMENT_NODE) {
                throw new IllegalArgumentException("Element without Id must be the document root");
            }
            refUri = "";
        }

        DataObjectDesc dataObjRef = new DataObjectReference(refUri).withTransform(new DataObjectTransform(Transforms.TRANSFORM_ENVELOPED_SIGNATURE));
        XadesSignatureResult result = signer.sign(new SignedDataObjects(dataObjRef).withCommitmentType(AllDataObjsCommitmentTypeProperty.proofOfOrigin()), signatureParent);


        writeXMLToFile(sourceDoc, outputPath);
    }
    private Document getDocument(String path) throws Exception {
        // Load the XML to append the signature to.
        File fXmlFile = new File(path);
        DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
        DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
        Document doc = dBuilder.parse(fXmlFile);
        doc.getDocumentElement().normalize();
        return doc;
    }
    
}
